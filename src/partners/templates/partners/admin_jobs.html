<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Partner Jobs (Admin)</title>
    <style>pre{white-space:pre-wrap;border:1px solid #ccc;padding:8px;}</style>
  </head>
  <body>
    <h1>Partner Jobs</h1>
    <p><a href="/partner/admin">Back</a></p>
    <div id="summary">Loading...</div>
    <div id="jobs_container">Loading jobs...</div>
    <script>
      async function requeueJob(id) {
        try {
          const r = await fetch(`/partner/jobs/${id}/requeue`, { method: 'POST', credentials: 'same-origin' });
          if (!r.ok) {
            alert('Requeue failed: ' + r.status);
            return;
          }
          load();
        } catch (e) {
          alert('Requeue error: ' + e);
        }
      }

      function renderJobs(recent) {
        if (!recent || recent.length === 0) {
          document.getElementById('jobs_container').textContent = 'No recent jobs';
          return;
        }
        const container = document.getElementById('jobs_container');
        container.innerHTML = '';
        recent.forEach(job => {
          const div = document.createElement('div');
          div.style.border = '1px solid #ddd';
          div.style.padding = '8px';
          div.style.margin = '6px 0';
          const pre = document.createElement('pre');
          pre.textContent = JSON.stringify(job, null, 2);
          div.appendChild(pre);
          const btn = document.createElement('button');
          btn.textContent = 'Requeue';
          btn.onclick = () => requeueJob(job.id);
          div.appendChild(btn);
          container.appendChild(div);
        });
      }

      async function load() {
        try {
          const r = await fetch('/partner/jobs', {credentials: 'same-origin'});
          if (!r.ok) {
            document.getElementById('summary').textContent = 'Failed to load jobs: ' + r.status;
            return;
          }
          const j = await r.json();
          document.getElementById('summary').textContent = `Counts: enqueued=${j.counts.pending}, in_progress=${j.counts.in_progress}, done=${j.counts.done}, failed=${j.counts.failed}`;
          renderJobs(j.recent);
        } catch (err) {
          document.getElementById('summary').textContent = 'Request error: ' + err;
        }
      }
      load();
    </script>
  </body>
</html>